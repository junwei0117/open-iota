<template>
  <div id="app">
    <div class="container">
      <nav class="navbar">
        <div class="navbar-brand">
          <router-link :to="{ name: 'Home' }" class="navbar-item">
            <img
              src="./assets/logo.png"
              alt="logo"
              width="28"
              height="28"
              style="margin-right: 6px"
            />
            <h1 class="heading title"></h1>
            <h1 class="heading title is-4">Open IOTA</h1>
          </router-link>
          <div
            class="navbar-burger"
            v-bind:class="{ 'is-active': navVisible }"
            @click="navVisible = !navVisible"
          >
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <div class="navbar-menu" v-bind:class="{ 'is-active': navVisible }">
          <div class="navbar-start"></div>
          <div class="navbar-end">
            <div class="navbar-item">
              <b-dropdown @change="connectToIOTA" v-model="iota.provider" position="is-bottom-left">
                <button
                  type="button"
                  slot="trigger"
                  class="button"
                  :class="{
                    'is-loading': iota.status === 'Connecting',
                    'is-primary': iota.status === 'Connected',
                    'is-danger': iota.status === 'Failed'}"
                >
                  <span class="icon is-small">
                    <i
                      class="fa"
                      :class="{
                    'fa-wifi': iota.status === 'Connected',
                    'fas fa-exclamation-triangle': iota.status === 'Failed',
                    'fa-spinner fa-pulse': iota.status === 'Connecting'
                    }"
                    ></i>
                  </span>
                  <span>{{ this.iota.status }}</span>
                  <b-icon icon="arrow_drop_down"></b-icon>
                </button>

                <b-dropdown-item custom>
                  <h1 class="title is-6">Latest Milestone:</h1>
                  <b-field class="subtitle">
                    <b-input expanded spellcheck="false" readonly :value="iota.latestMilestone"></b-input>
                    <p class="control">
                      <button class="button is-primary" v-clipboard:copy="iota.latestMilestone">Copy</button>
                    </p>
                  </b-field>
                </b-dropdown-item>
                <b-dropdown-item custom>
                  <h1 class="title is-6">Latest Solid Milestone:</h1>
                  <b-field class="subtitle">
                    <b-input
                      expanded
                      spellcheck="false"
                      readonly
                      :value="iota.latestSolidMilestone"
                    ></b-input>
                    <p class="control">
                      <button
                        class="button is-primary"
                        v-clipboard:copy="iota.latestSolidMilestone"
                      >Copy</button>
                    </p>
                  </b-field>
                </b-dropdown-item>
                <b-dropdown-item custom>
                  Node version:
                  <b>{{ iota.version || "..." }}</b>
                </b-dropdown-item>
                <b-dropdown-item custom>
                  Node health:
                  <b>{{ providerHealth }}</b>
                </b-dropdown-item>
                <hr class="dropdown-divider" />
                <div v-for="prov in providerList">
                  <b-dropdown-item :value="prov">
                    <div class="media">
                      <b-icon v-if="prov.includes('https:')" class="media-left" icon="lock"></b-icon>
                      <b-icon v-else class="media-left" icon="public"></b-icon>
                      <div class="media-content">
                        <h3>{{ prov }}</h3>
                      </div>
                    </div>
                  </b-dropdown-item>
                </div>
                <b-dropdown-item custom>
                  <h1 class="title is-6">Custom Provider:</h1>
                  <b-field class="subtitle">
                    <b-input expanded spellcheck="false" v-model.sync="customProvider"></b-input>
                    <p class="control">
                      <button class="button is-primary" @click="addProvider">Add</button>
                    </p>
                  </b-field>
                </b-dropdown-item>
              </b-dropdown>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <router-view :iota="iota.link"></router-view>

    <!-- Open IOTA Ad -->
    <ins
      class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-5014469443290772"
      data-ad-slot="8143969435"
      data-ad-format="auto"
      data-full-width-responsive="true"
    ></ins>

    <footer class="footer">
      <div class="container">
        <div class="columns">
          <div class="column">
            <h1 class="heading title is-4">Open IOTA</h1>
            <h1 class="subtitle is-6">A simple, free, open-source tangle explorer for IOTA</h1>
          </div>
        </div>
      </div>
    </footer>

    <b-modal :active.sync="isProviderModalActive">
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Changing IOTA Server</p>
          <button class="delete" aria-label="close" @click="closeModal"></button>
        </header>
        <section class="modal-card-body">
          <div>Doing this will open this website in another tab.</div>
          <br />
          <div>
            The technical reason for this is that when you interact with an
            <code>http</code> server, but the website itself is served over
            <code>https</code>, the requests will be blocked by the web browser. (This is a security feature built into web browsers.) Therefore, you must go to the
            <code>http</code> version of this website to interact with
            <code>http</code> IOTA servers.
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" @click="openHTTPSite">OK</button>
          <button class="button" @click="closeModal">Cancel</button>
        </footer>
      </div>
    </b-modal>
  </div>
</template>

<script>
import IOTA from "iota.lib.js";
import ValueHelper from "./components/mixins/ValuesHelper";
import BModal from "buefy/src/components/modal/Modal";
import curlTransaction from "curl-transaction-core";
import curlImpl from "curl-transaction-webgl2-impl";

// public node list from IOTA's mainnet nodes, https://iotasupport.com/providers.json, and http://iotanode.host/
const defaultProviderList = [
  // http nodes
  "http://node1.puyuma.org:14265"
];

const initialProvider = "http://node1.puyuma.org:14265";

let localAttachToTangle = null;

export default {
  components: { BModal },
  name: "app",
  mixins: [ValueHelper],
  data() {
    return {
      navVisible: false,
      customProvider: "",
      donationAddress: "Coming soon...",
      providerList: defaultProviderList,
      iota: {
        status: "",
        link: null,
        provider: initialProvider,
        connected: false,
        latestMilestone: "",
        latestSolidMilestone: "",
        latestMilestoneIndex: 0,
        latestSolidSubtangleMilestoneIndex: 0
      },
      isProviderModalActive: false,
      intendedHTTPSite: null
    };
  },
  computed: {
    providerHealth() {
      return (
        this.iota.latestSolidSubtangleMilestoneIndex +
        " / " +
        this.iota.latestMilestoneIndex
      );
    }
  },
  methods: {
    addProvider() {
      if (this.customProvider) {
        this.providerList.push(this.customProvider);
        this.customProvider = "";
      }
    },
    connectToIOTA() {
      // if(window.location.protocol.includes('http:')) {
      if (
        window.location.protocol.includes("https:") &&
        this.iota.provider.includes("http:")
      ) {
        this.intendedHTTPSite = this.iota.provider;
        this.isProviderModalActive = true;
        // FIXME: this.iota.provider is stale
        // this.iota.provider = this.iota.link.provider ?
        return;
      }

      this.iota.status = "Connecting"; // TODO: rename this.iota to this.iotaConnectionController
      this.iota.connected = false;
      this.iota.latestMilestoneIndex = 0;
      this.iota.latestSolidSubtangleMilestoneIndex = 0;
      this.iota.version = null;

      this.iota.link = new IOTA({
        provider: this.iota.provider
      });

      this.iota.link.api.attachToTangle = localAttachToTangle;

      let currentLink = this.iota.link;

      this.iota.link.api.getNodeInfo((err, success) => {
        if (currentLink !== this.iota.link) {
          return;
        }
        if (err) {
          this.iota.status = "Failed";
          return;
        }
        this.iota.status = "Connected";
        this.iota.connected = true;
        this.iota.latestMilestone = success.latestMilestone;
        this.iota.latestSolidMilestone = success.latestSolidSubtangleMilestone;
        this.iota.latestMilestoneIndex = success.latestMilestoneIndex;
        this.iota.latestSolidSubtangleMilestoneIndex =
          success.latestSolidSubtangleMilestoneIndex;
        this.iota.version = success.appVersion;
      });
    },
    openHTTPSite() {
      this.isProviderModalActive = false;
      window.open(window.location.href.replace("https:", "http:"), "_blank");
    },
    closeModal() {
      this.isProviderModalActive = false;
    }
  },
  mounted() {
    if (!curlImpl.error) {
      localAttachToTangle = curlTransaction({ curlImpl }).localAttachToTangle;
      console.log("Your browser does support WebGL2");
    } else {
      console.error("Your browser does not support WebGL2");
      this.isWebGL2Supported = false;
    }

    this.connectToIOTA();
  }
};
</script>

